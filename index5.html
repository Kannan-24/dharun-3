<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAMAIAH Rocket & Mission Simulator — RIT / Designed by Dharun M</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #0b1220;
            --panel: #0f1724;
            --border: rgba(255, 255, 255, 0.08);
            --rit-primary: #a50034;
            /* Ramaiah Maroon */
            --rit-accent: #ffcc00;
            /* Gold */
            --text-main: #e6eef8;
            --text-muted: #9aa7bf;
            --success: #00e676;
            --danger: #ff1744;
            --chart-grid: rgba(255, 255, 255, 0.05);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER */
        header {
            background: linear-gradient(90deg, #050a14 0%, var(--panel) 100%);
            border-bottom: 3px solid var(--rit-primary);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
            flex-shrink: 0;
        }

        .brand-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .logo-box {
            width: 50px;
            height: 50px;
            background: var(--rit-primary);
            color: white;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 1.2rem;
            border: 2px solid var(--rit-accent);
        }

        .titles h1 {
            margin: 0;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .titles h2 {
            margin: 0;
            font-size: 0.75rem;
            color: var(--rit-accent);
            font-weight: 600;
        }

        .designer {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .system-status {
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
            font-family: monospace;
            color: var(--text-muted);
        }

        .status-badge {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            color: #fff;
        }

        /* MAIN LAYOUT */
        .workspace {
            display: grid;
            grid-template-columns: 320px 1fr;
            flex: 1;
            overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            background: var(--panel);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .config-section {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        .config-header {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--rit-accent);
            text-transform: uppercase;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
            margin-top: 8px;
        }

        input,
        select {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            color: white;
            padding: 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85rem;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--rit-accent);
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        button {
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .btn-primary {
            background: var(--rit-primary);
            color: white;
            width: 100%;
            margin-top: 15px;
        }

        .btn-primary:hover {
            background: #c9003f;
            box-shadow: 0 0 10px rgba(165, 0, 52, 0.4);
        }

        .btn-sec {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
        }

        .btn-sec:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* DASHBOARD */
        .dashboard {
            background: #050a14;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* TELEMETRY BAR */
        .telemetry-strip {
            background: #000;
            border-bottom: 1px solid var(--border);
            padding: 10px;
            display: flex;
            gap: 20px;
            font-family: monospace;
            overflow-x: auto;
            white-space: nowrap;
        }

        .tel-item {
            display: flex;
            flex-direction: column;
        }

        .tel-label {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .tel-val {
            font-size: 1rem;
            color: var(--rit-accent);
            font-weight: bold;
        }

        /* GRAPHS GRID */
        .charts-container {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            /* 4 columns for 16 graphs */
            grid-auto-rows: 180px;
            gap: 10px;
        }

        .chart-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            position: relative;
        }

        .chart-title {
            position: absolute;
            top: 6px;
            left: 8px;
            font-size: 0.65rem;
            color: var(--text-muted);
            font-weight: bold;
            text-transform: uppercase;
        }

        canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* CONSOLE LOG */
        .console-log {
            height: 120px;
            background: #000;
            border-top: 1px solid var(--rit-primary);
            padding: 10px;
            font-family: monospace;
            font-size: 0.75rem;
            color: #ccc;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 2px;
            border-bottom: 1px solid #111;
        }

        .ts {
            color: var(--rit-accent);
            margin-right: 8px;
        }

        /* FOOTER */
        footer {
            background: var(--panel);
            font-size: 0.7rem;
            color: var(--text-muted);
            text-align: center;
            padding: 5px;
            border-top: 1px solid var(--border);
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #000;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        /* RESPONSIVE */
        @media (max-width: 1400px) {
            .charts-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 1100px) {
            .charts-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>

    <header>
        <div class="brand-group">
            <div class="logo-box">RIT</div>
            <div class="titles">
                <h1>Ramaiah Rocket Simulator</h1>
                <div class="designer">Department of Aerospace Engineering</div>
            </div>
        </div>
        <div class="brand-group">
            <div class="titles" style="text-align: right;">
                <h2>MISSION CONTROL</h2>
                <div class="designer">Designed by Dharun M</div>
            </div>
            <div class="system-status">
                <div class="status-badge" id="clock-utc">UTC 00:00:00</div>
                <div class="status-badge" style="background:var(--rit-primary)">SYS ONLINE</div>
            </div>
        </div>
    </header>

    <div class="workspace">
        <aside class="sidebar">

            <div class="config-section">
                <div class="config-header">Mission Profile</div>
                <label>Mission Name</label>
                <input type="text" id="in-mission" value="RIT-Sat Launch 01">

                <label>Target Orbit Altitude (km)</label>
                <input type="number" id="in-orbit" value="400">

                <label>Launch Site Lat/Lon</label>
                <input type="text" id="in-latlon" placeholder="13.03, 77.56" value="13.03, 77.56">
                <button class="btn-sec" style="margin-top:5px; font-size:0.7rem;" onclick="getGeo()">Auto-Detect
                    Location</button>
            </div>

            <div class="config-section">
                <div class="config-header">Vehicle Configuration</div>
                <label>Load Preset</label>
                <select id="in-preset" onchange="loadPreset()">
                    <option value="falcon9">Falcon 9 Block 5</option>
                    <option value="pslv">PSLV-XL (ISRO)</option>
                    <option value="gslv">LVM3 (ISRO)</option>
                    <option value="starship">Starship (SpaceX)</option>
                    <option value="electron">Electron (Rocket Lab)</option>
                    <option value="custom">Custom Configuration</option>
                </select>

                <label>Dry Mass (kg)</label>
                <input type="number" id="in-dry" value="25000">

                <label>Fuel Mass (kg)</label>
                <input type="number" id="in-fuel" value="400000">

                <label>ISP Sea Level (s)</label>
                <input type="number" id="in-isp" value="282">

                <label>Max Thrust (kN)</label>
                <input type="number" id="in-thrust" value="7600">

                <label>Stages</label>
                <select id="in-stages">
                    <option value="1">1 Stage (SSTO)</option>
                    <option value="2" selected>2 Stages</option>
                    <option value="3">3 Stages</option>
                </select>
            </div>

            <div class="config-section">
                <div class="config-header">Flight Computer</div>
                <label>Guidance Algorithm</label>
                <select id="in-guidance">
                    <option value="gravity">Gravity Turn (Standard)</option>
                    <option value="direct">Direct Ascent (Vertical)</option>
                </select>

                <label>Simulation Speed</label>
                <select id="in-timewarp">
                    <option value="1">1x (Real-time)</option>
                    <option value="5">5x</option>
                    <option value="10">10x</option>
                    <option value="50">50x</option>
                </select>

                <button class="btn-primary" id="btn-launch" onclick="toggleSim()">INITIATE LAUNCH</button>
                <div class="btn-group">
                    <button class="btn-sec" onclick="exportData()">JSON Export</button>
                    <button class="btn-sec" onclick="resetSim()">Reset</button>
                </div>
            </div>

        </aside>

        <main class="dashboard">

            <div class="telemetry-strip">
                <div class="tel-item"><span class="tel-label">T+ CLOCK</span><span class="tel-val"
                        id="tel-time">00:00.0</span></div>
                <div class="tel-item"><span class="tel-label">ALTITUDE</span><span class="tel-val" id="tel-alt">0.0
                        km</span></div>
                <div class="tel-item"><span class="tel-label">VELOCITY</span><span class="tel-val" id="tel-vel">0
                        m/s</span></div>
                <div class="tel-item"><span class="tel-label">ACCEL</span><span class="tel-val" id="tel-acc">0.00
                        G</span></div>
                <div class="tel-item"><span class="tel-label">Q (DYN PRESS)</span><span class="tel-val" id="tel-q">0.0
                        kPa</span></div>
                <div class="tel-item"><span class="tel-label">FUEL</span><span class="tel-val" id="tel-fuel">100%</span>
                </div>
                <div class="tel-item"><span class="tel-label">STATUS</span><span class="tel-val" id="tel-status"
                        style="color:white">READY</span></div>
            </div>

            <div class="charts-container" id="charts-area">
                <div class="chart-card">
                    <div class="chart-title">Altitude (km)</div><canvas id="c-alt"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Velocity (m/s)</div><canvas id="c-vel"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Acceleration (G)</div><canvas id="c-acc"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Thrust (kN)</div><canvas id="c-thrust"></canvas>
                </div>

                <div class="chart-card">
                    <div class="chart-title">Vehicle Mass (ton)</div><canvas id="c-mass"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Dyn Pressure Q (kPa)</div><canvas id="c-q"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Aerodynamic Drag (kN)</div><canvas id="c-drag"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Angle of Attack (deg)</div><canvas id="c-aoa"></canvas>
                </div>

                <div class="chart-card">
                    <div class="chart-title">Stage Status</div><canvas id="c-stage"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Pitch Angle (deg)</div><canvas id="c-pitch"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Flight Path Angle</div><canvas id="c-fpa"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Delta-V Expended</div><canvas id="c-dv"></canvas>
                </div>

                <div class="chart-card">
                    <div class="chart-title">Fuel Flow Rate (kg/s)</div><canvas id="c-flow"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Atmospheric Density</div><canvas id="c-rho"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Gravitational Load</div><canvas id="c-gload"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Orbital Eccentricity</div><canvas id="c-ecc"></canvas>
                </div>
            </div>

            <div class="console-log" id="sim-console">
                <div class="log-entry"><span class="ts">[SYS]</span> Ramaiah Orbital Simulator initialized.</div>
                <div class="log-entry"><span class="ts">[SYS]</span> Waiting for configuration...</div>
            </div>
        </main>
    </div>

    <footer>
        © 2025 Ramaiah Institute of Technology | Advanced Flight Dynamics Lab | Version 4.2 Pro
    </footer>

    <script>
        /**
         * ----------------------------------------------------------------------
         * RIT ORBITAL SIMULATOR CORE ENGINE
         * ----------------------------------------------------------------------
         */

        // --- PRESETS DATABASE ---
        const PRESETS = {
            falcon9: { dry: 25600, fuel: 411000, isp: 282, thrust: 7607, stages: 2 },
            pslv: { dry: 10000, fuel: 138000, isp: 269, thrust: 4800, stages: 3 }, // Simplified XL
            gslv: { dry: 28000, fuel: 400000, isp: 290, thrust: 8000, stages: 3 }, // Mk3 approx
            starship: { dry: 100000, fuel: 1200000, isp: 330, thrust: 72000, stages: 2 },
            electron: { dry: 950, fuel: 11550, isp: 311, thrust: 190, stages: 2 }
        };

        // --- SIMULATION STATE ---
        const SIM = {
            running: false,
            t: 0,
            dt: 0.1, // physics step
            lastLog: 0,
            speed: 1,

            // Physics State
            y: 0,     // Altitude (m)
            v: 0,     // Velocity (m/s)
            a: 0,     // Accel (m/s^2)
            mass: 0,
            fuel: 0,
            pitch: 90,
            stage: 1,

            // Derived
            q: 0,
            drag: 0,
            thrust: 0,
            rho: 1.225,
            downrange: 0,

            config: {},
            history: []
        };

        // --- CHART.JS INSTANCES ---
        const charts = {};
        const chartKeys = ['alt', 'vel', 'acc', 'thrust', 'mass', 'q', 'drag', 'aoa', 'stage', 'pitch', 'fpa', 'dv', 'flow', 'rho', 'gload', 'ecc'];
        const chartColors = ['#00f3ff', '#00ff00', '#ffff00', '#ff0000', '#ff00ff', '#00f3ff', '#ffa500', '#fff', '#00ff00', '#ffff00', '#00f3ff', '#ff0000', '#00ff00', '#fff', '#ffa500', '#00f3ff'];

        // --- INITIALIZATION ---
        window.onload = function () {
            initCharts();
            updateClock();
            loadPreset(); // Default
            log("System Ready. Select preset or enter parameters.");
        };

        function getGeo() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(p => {
                    document.getElementById('in-latlon').value = `${p.coords.latitude.toFixed(4)}, ${p.coords.longitude.toFixed(4)}`;
                    log(`Location acquired: ${p.coords.latitude.toFixed(2)}, ${p.coords.longitude.toFixed(2)}`);
                });
            } else {
                log("Geolocation not supported by browser.");
            }
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('clock-utc').innerText = "UTC " + now.toISOString().split('T')[1].split('.')[0];
            setTimeout(updateClock, 1000);
        }

        function loadPreset() {
            const val = document.getElementById('in-preset').value;
            if (val === 'custom') return;
            const p = PRESETS[val];
            document.getElementById('in-dry').value = p.dry;
            document.getElementById('in-fuel').value = p.fuel;
            document.getElementById('in-isp').value = p.isp;
            document.getElementById('in-thrust').value = p.thrust;
            document.getElementById('in-stages').value = p.stages;
            log(`Loaded configuration: ${val.toUpperCase()}`);
        }

        function log(msg) {
            const con = document.getElementById('sim-console');
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = `<span class="ts">[${SIM.t.toFixed(1)}]</span> ${msg}`;
            con.prepend(div);
        }

        // --- CHART MANAGEMENT ---
        function initCharts() {
            Chart.defaults.color = '#666';
            Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';

            chartKeys.forEach((key, idx) => {
                const ctx = document.getElementById(`c-${key}`).getContext('2d');
                charts[key] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            borderColor: chartColors[idx],
                            borderWidth: 1.5,
                            pointRadius: 0,
                            tension: 0.2, // Smooth curves
                            fill: true,
                            backgroundColor: chartColors[idx] + '22' // Transparent fill
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false, // CRITICAL FOR PERFORMANCE
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { display: false }, // Hide X axis labels for clean look
                            y: { grid: { color: 'rgba(255,255,255,0.05)' } }
                        }
                    }
                });
            });
        }

        function updateCharts() {
            // Only update visuals if history exists
            if (SIM.history.length === 0) return;

            const latest = SIM.history[SIM.history.length - 1];

            // Push data to charts
            // We limit history length in charts to 100 points for performance
            const maxPoints = 100;

            const push = (key, val) => {
                const c = charts[key];
                c.data.labels.push(SIM.t.toFixed(0));
                c.data.datasets[0].data.push(val);
                if (c.data.labels.length > maxPoints) {
                    c.data.labels.shift();
                    c.data.datasets[0].data.shift();
                }
                c.update();
            };

            push('alt', SIM.y / 1000);
            push('vel', SIM.v);
            push('acc', SIM.a / 9.81);
            push('thrust', SIM.thrust / 1000);
            push('mass', SIM.mass / 1000);
            push('q', SIM.q / 1000);
            push('drag', SIM.drag / 1000);
            push('aoa', 90 - SIM.pitch); // Simplified
            push('stage', SIM.stage);
            push('pitch', SIM.pitch);
            push('fpa', 90 - SIM.pitch); // Simplified Flight Path Angle
            push('dv', SIM.v); // Approx
            push('flow', (SIM.thrust / (SIM.config.isp * 9.81)));
            push('rho', SIM.rho);
            push('gload', (SIM.a / 9.81) + 1);
            push('ecc', (SIM.y > 100000 ? 0.05 : 0)); // Fake ecc until orbit
        }

        // --- PHYSICS ENGINE ---
        function toggleSim() {
            if (SIM.running) {
                SIM.running = false;
                document.getElementById('btn-launch').innerText = "RESUME LAUNCH";
                log("Simulation PAUSED.");
            } else {
                if (SIM.t === 0) startSim();
                SIM.running = true;
                document.getElementById('btn-launch').innerText = "PAUSE SIMULATION";
                document.getElementById('tel-status').innerText = "IN FLIGHT";
                document.getElementById('tel-status').style.color = "var(--success)";
                loop();
            }
        }

        function startSim() {
            // Read Config
            SIM.config = {
                dry: parseFloat(document.getElementById('in-dry').value),
                fuel: parseFloat(document.getElementById('in-fuel').value),
                isp: parseFloat(document.getElementById('in-isp').value),
                thrust: parseFloat(document.getElementById('in-thrust').value) * 1000, // to N
                stages: parseInt(document.getElementById('in-stages').value),
                guidance: document.getElementById('in-guidance').value
            };

            SIM.mass = SIM.config.dry + SIM.config.fuel;
            SIM.fuel = SIM.config.fuel;
            log("T-0: IGNITION. Liftoff confirmed.");
        }

        function resetSim() {
            SIM.running = false;
            SIM.t = 0;
            SIM.y = 0; SIM.v = 0; SIM.a = 0; SIM.pitch = 90;
            SIM.history = [];
            document.getElementById('btn-launch').innerText = "INITIATE LAUNCH";
            document.getElementById('tel-status').innerText = "READY";
            document.getElementById('tel-status').style.color = "white";

            // Clear charts
            Object.values(charts).forEach(c => {
                c.data.labels = [];
                c.data.datasets[0].data = [];
                c.update();
            });

            updateTelemetryUI();
            log("Simulation RESET.");
        }

        function loop() {
            if (!SIM.running) return;

            // Time Warp
            const warp = parseInt(document.getElementById('in-timewarp').value);
            const steps = warp; // Run X physics steps per frame

            for (let i = 0; i < steps; i++) {
                stepPhysics();
            }

            updateTelemetryUI();

            // Throttled Chart Update (every 10 frames approx to save CPU)
            if (Math.floor(SIM.t * 10) % 5 === 0) {
                updateCharts();
            }

            requestAnimationFrame(loop);
        }

        function stepPhysics() {
            const dt = SIM.dt;

            // 1. Atmosphere (US Standard Atmosphere approx)
            if (SIM.y < 0) SIM.y = 0;
            const T = 288.15 - 0.0065 * SIM.y;
            const P = 101325 * Math.pow((1 - 0.0000225577 * SIM.y), 5.25588);
            SIM.rho = (P / (287.05 * T)) || 0;
            if (SIM.y > 100000) SIM.rho = 0; // Space

            // 2. Guidance (Pitch Program)
            if (SIM.config.guidance === 'gravity') {
                // Start turn at 1km, end at 100km
                if (SIM.y > 1000 && SIM.y < 150000) {
                    const progress = (SIM.y - 1000) / 149000;
                    SIM.pitch = 90 - (progress * 90);
                } else if (SIM.y >= 150000) {
                    SIM.pitch = 0;
                }
            }

            // 3. Forces
            const g = 9.81 * Math.pow(6371000 / (6371000 + SIM.y), 2);

            // Thrust
            let Ft = 0;
            if (SIM.fuel > 0) {
                // ISP changes with pressure (Simplified)
                const vacISP = SIM.config.isp * 1.15;
                const curISP = SIM.config.isp + (vacISP - SIM.config.isp) * (1 - (SIM.rho / 1.225));

                Ft = SIM.config.thrust; // Constant thrust logic for demo
                const mdot = Ft / (curISP * 9.81);
                SIM.fuel -= mdot * dt;
                SIM.mass -= mdot * dt;
                SIM.thrust = Ft;
            } else {
                SIM.thrust = 0;
                if (SIM.v > 7000 && SIM.status !== "ORBIT") {
                    SIM.status = "ORBIT";
                    log("MECO. Orbit Insertion Complete.");
                }
            }

            // Drag
            const area = 10; // m^2 approx
            const cd = 0.5;
            SIM.q = 0.5 * SIM.rho * SIM.v * SIM.v;
            SIM.drag = SIM.q * cd * area;

            // Net Force (Vertical approximate for 1D logic)
            // Decompose Thrust vertical component
            const rad = SIM.pitch * (Math.PI / 180);
            const Fty = Ft * Math.sin(rad);
            const Ftx = Ft * Math.cos(rad); // Horizontal gain

            const Fdy = SIM.drag * (SIM.v > 0 ? -1 : 1) * Math.sin(rad); // Drag opposes motion

            const FnetY = Fty + Fdy - (SIM.mass * g);

            // Acceleration
            SIM.a = FnetY / SIM.mass;

            // Integration
            const vy = SIM.v * Math.sin(rad) + SIM.a * dt;
            const vx = SIM.v * Math.cos(rad) + (Ftx / SIM.mass) * dt;

            SIM.v = Math.sqrt(vx * vx + vy * vy); // Magnitude
            SIM.y += vy * dt;
            SIM.t += dt;

            // Events
            if (SIM.fuel <= 0 && SIM.stage === 1 && SIM.config.stages > 1) {
                log(`Stage ${SIM.stage} Burnout. Separation initiated.`);
                SIM.stage++;
                SIM.mass -= (SIM.config.dry * 0.5); // Drop booster mass
                // Refuel second stage logic (Simplified for single tank input)
                SIM.fuel = SIM.config.fuel * 0.2;
                SIM.config.thrust = SIM.config.thrust * 0.2; // Smaller engine
                log(`Stage ${SIM.stage} Ignition.`);
            }

            // History recording
            if (SIM.t % 0.5 < dt) {
                SIM.history.push({
                    t: SIM.t, alt: SIM.y, vel: SIM.v, acc: SIM.a,
                    mass: SIM.mass, q: SIM.q, thrust: SIM.thrust
                });
            }
        }

        function updateTelemetryUI() {
            document.getElementById('tel-time').innerText = formatTime(SIM.t);
            document.getElementById('tel-alt').innerText = (SIM.y / 1000).toFixed(2) + " km";
            document.getElementById('tel-vel').innerText = SIM.v.toFixed(0) + " m/s";
            document.getElementById('tel-acc').innerText = (SIM.a / 9.81).toFixed(2) + " G";
            document.getElementById('tel-q').innerText = (SIM.q / 1000).toFixed(1) + " kPa";
            const fuelPct = Math.max(0, (SIM.fuel / SIM.config.fuel) * 100);
            document.getElementById('tel-fuel').innerText = fuelPct.toFixed(1) + "%";
        }

        function formatTime(s) {
            const min = Math.floor(s / 60);
            const sec = (s % 60).toFixed(1);
            return `${min < 10 ? '0' + min : min}:${sec < 10 ? '0' + sec : sec}`;
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(SIM.history));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", "RIT_Flight_Data.json");
            dlAnchorElem.click();
        }

    </script>
</body>

</html>