<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Rocket Flight Simulator</title>
    <style>
        :root {
            --primary: #0b3d91;
            --accent: #fc3d21;
            --bg: #121212;
            --panel: #1e1e1e;
            --text: #e0e0e0;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', monospace;
            background: var(--bg);
            color: var(--text);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Layout */
        #sidebar {
            width: 320px;
            background: var(--panel);
            padding: 20px;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #canvas-container {
            flex: 1;
            background: linear-gradient(to bottom, #000022 0%, #87CEEB 100%);
            position: relative;
            overflow: hidden;
        }

        #plot-container {
            height: 250px;
            background: #000;
            border-top: 1px solid #333;
            position: relative;
        }

        /* UI Elements */
        h2 {
            color: var(--accent);
            margin-top: 0;
            font-size: 1.2rem;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }

        .control-group {
            margin-bottom: 20px;
            background: #2a2a2a;
            padding: 10px;
            border-radius: 4px;
        }

        label {
            display: block;
            font-size: 0.8rem;
            margin-bottom: 5px;
            color: #aaa;
        }

        input[type="range"] {
            width: 100%;
        }

        .value-display {
            float: right;
            color: var(--accent);
            font-weight: bold;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            width: 100%;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 5px;
            border-radius: 4px;
            transition: 0.2s;
        }

        button:hover {
            background: #1a5dbf;
        }

        button.reset {
            background: #444;
        }

        /* Stats Overlay */
        #telemetry {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 4px;
            pointer-events: none;
            font-family: monospace;
        }

        .telemetry-row {
            display: flex;
            justify-content: space-between;
            width: 200px;
            margin-bottom: 5px;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>

    <div id="sidebar">
        <h2>ROCKET CONFIGURATION</h2>

        <div class="control-group">
            <label>Dry Mass (kg) <span id="val-mass" class="value-display">50</span></label>
            <input type="range" id="in-mass" min="10" max="200" value="50">
        </div>

        <div class="control-group">
            <label>Fuel Mass (kg) <span id="val-fuel" class="value-display">100</span></label>
            <input type="range" id="in-fuel" min="10" max="500" value="100">
        </div>

        <div class="control-group">
            <label>Drag Coefficient (Cd) <span id="val-drag" class="value-display">0.75</span></label>
            <input type="range" id="in-drag" min="0.1" max="2.0" step="0.05" value="0.75">
        </div>

        <div class="control-group">
            <label>Thrust (Newtons) <span id="val-thrust" class="value-display">3000</span></label>
            <input type="range" id="in-thrust" min="500" max="10000" step="100" value="3000">
        </div>

        <div class="control-group">
            <label>Burn Rate (kg/s) <span id="val-burn" class="value-display">2.5</span></label>
            <input type="range" id="in-burn" min="0.1" max="10.0" step="0.1" value="2.5">
        </div>

        <h2>SIMULATION CONTROL</h2>
        <button id="btn-launch">LAUNCH</button>
        <button id="btn-reset" class="reset">RESET</button>

        <div style="margin-top: 20px; font-size: 0.8rem; color: #888;">
            <strong>Status:</strong> <span id="sim-status">READY</span>
        </div>
    </div>

    <div id="main">
        <div id="canvas-container">
            <canvas id="world-canvas"></canvas>
            <div id="telemetry">
                <div class="telemetry-row"><span>Altitude:</span> <span id="tel-alt">0 m</span></div>
                <div class="telemetry-row"><span>Velocity:</span> <span id="tel-vel">0 m/s</span></div>
                <div class="telemetry-row"><span>Accel:</span> <span id="tel-acc">0 m/s²</span></div>
                <div class="telemetry-row"><span>Fuel:</span> <span id="tel-fuel">100%</span></div>
                <div class="telemetry-row"><span>Time:</span> <span id="tel-time">0.0 s</span></div>
            </div>
        </div>
        <div id="plot-container">
            <canvas id="plot-canvas"></canvas>
        </div>
    </div>

    <script>
        /**
         * SIMULATION ENGINE
         * Implements simplified Newtonian physics with variable mass and aerodynamic drag.
         */
        const CONFIG = {
            dt: 0.02,          // Time step (s)
            g: 9.81,           // Gravity (m/s^2)
            airDensity: 1.225, // Sea level density (kg/m^3)
            scale: 0.5         // Pixels per meter (visual scale)
        };

        const STATE = {
            t: 0,
            y: 0,              // Altitude (m)
            v: 0,              // Velocity (m/s)
            a: 0,              // Acceleration (m/s^2)
            running: false,
            finished: false,
            history: [],       // Data for plotting

            // Configurable parameters
            dryMass: 50,
            fuelMass: 100,
            currentFuel: 100,
            cd: 0.75,
            area: 0.1,         // Cross-sectional area (m^2)
            thrust: 3000,
            burnRate: 2.5
        };

        // UI Elements
        const els = {
            canvas: document.getElementById('world-canvas'),
            ctx: document.getElementById('world-canvas').getContext('2d'),
            plotCanvas: document.getElementById('plot-canvas'),
            plotCtx: document.getElementById('plot-canvas').getContext('2d'),
            inputs: {
                mass: document.getElementById('in-mass'),
                fuel: document.getElementById('in-fuel'),
                drag: document.getElementById('in-drag'),
                thrust: document.getElementById('in-thrust'),
                burn: document.getElementById('in-burn')
            },
            displays: {
                mass: document.getElementById('val-mass'),
                fuel: document.getElementById('val-fuel'),
                drag: document.getElementById('val-drag'),
                thrust: document.getElementById('val-thrust'),
                burn: document.getElementById('val-burn'),
                alt: document.getElementById('tel-alt'),
                vel: document.getElementById('tel-vel'),
                acc: document.getElementById('tel-acc'),
                fuelTel: document.getElementById('tel-fuel'),
                time: document.getElementById('tel-time'),
                status: document.getElementById('sim-status')
            }
        };

        // Initialization
        function init() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // Bind Inputs
            Object.keys(els.inputs).forEach(key => {
                els.inputs[key].addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    els.displays[key].innerText = val;
                    updateParams();
                });
            });

            document.getElementById('btn-launch').addEventListener('click', launch);
            document.getElementById('btn-reset').addEventListener('click', reset);

            updateParams();
            drawWorld();
            drawPlot();
        }

        function updateParams() {
            if (STATE.running) return;
            STATE.dryMass = parseFloat(els.inputs.mass.value);
            STATE.fuelMass = parseFloat(els.inputs.fuel.value);
            STATE.currentFuel = STATE.fuelMass;
            STATE.cd = parseFloat(els.inputs.drag.value);
            STATE.thrust = parseFloat(els.inputs.thrust.value);
            STATE.burnRate = parseFloat(els.inputs.burn.value);
        }

        function resizeCanvas() {
            els.canvas.width = els.canvas.parentElement.offsetWidth;
            els.canvas.height = els.canvas.parentElement.offsetHeight;
            els.plotCanvas.width = els.plotCanvas.parentElement.offsetWidth;
            els.plotCanvas.height = els.plotCanvas.parentElement.offsetHeight;
            if (!STATE.running) { drawWorld(); drawPlot(); }
        }

        /**
         * PHYSICS LOOP
         */
        function stepPhysics() {
            if (!STATE.running) return;

            // 1. Calculate Forces
            let thrustForce = 0;

            // Burn Fuel
            if (STATE.currentFuel > 0) {
                thrustForce = STATE.thrust;
                STATE.currentFuel -= STATE.burnRate * CONFIG.dt;
                if (STATE.currentFuel < 0) STATE.currentFuel = 0;
            }

            // Gravity
            const totalMass = STATE.dryMass + STATE.currentFuel;
            const gravityForce = totalMass * CONFIG.g;

            // Aerodynamic Drag (F_d = 0.5 * rho * v^2 * Cd * A)
            // Direction opposes velocity
            const dragDir = STATE.v > 0 ? -1 : 1;
            const dragForce = 0.5 * CONFIG.airDensity * (STATE.v * STATE.v) * STATE.cd * STATE.area * dragDir;

            // Net Force & Acceleration
            const netForce = thrustForce - gravityForce + dragForce;
            STATE.a = netForce / totalMass;

            // Integrator (Euler)
            STATE.v += STATE.a * CONFIG.dt;
            STATE.y += STATE.v * CONFIG.dt;
            STATE.t += CONFIG.dt;

            // Ground Collision
            if (STATE.y <= 0) {
                STATE.y = 0;
                STATE.v = 0;
                STATE.a = 0;
                if (STATE.t > 1) { // Stop if we've been running for a bit
                    STATE.running = false;
                    STATE.finished = true;
                    els.displays.status.innerText = "LANDED / CRASHED";
                }
            }

            // Data Recording
            if (STATE.t % 0.1 < CONFIG.dt) { // Record every ~0.1s
                STATE.history.push({
                    t: STATE.t,
                    y: STATE.y,
                    v: STATE.v,
                    fuel: STATE.currentFuel
                });
            }

            updateTelemetry();
        }

        function updateTelemetry() {
            els.displays.alt.innerText = STATE.y.toFixed(1) + " m";
            els.displays.vel.innerText = STATE.v.toFixed(1) + " m/s";
            els.displays.acc.innerText = STATE.a.toFixed(1) + " m/s²";
            els.displays.fuelTel.innerText = ((STATE.currentFuel / STATE.fuelMass) * 100).toFixed(0) + "%";
            els.displays.time.innerText = STATE.t.toFixed(1) + " s";
        }

        /**
         * RENDER LOOP
         */
        function drawWorld() {
            const ctx = els.ctx;
            const w = els.canvas.width;
            const h = els.canvas.height;

            // Sky is CSS gradient, just clear
            ctx.clearRect(0, 0, w, h);

            // Camera Logic (Follow Rocket vertically)
            // Map rocket Y to screen Y. Keep rocket in middle-lower third unless low alt.
            const groundY = h - 50;
            const scale = Math.max(0.5, 200 / (STATE.y + 100)); // Dynamic zoom

            // Draw Ground
            ctx.fillStyle = "#2e8b57";
            ctx.fillRect(0, groundY, w, 50);

            // Draw Rocket
            const rocketScreenY = groundY - (STATE.y * scale * 5); // Simple scaling
            const rocketW = 20 * scale;
            const rocketH = 60 * scale;
            const rocketX = w / 2 - rocketW / 2;

            // Flame
            if (STATE.currentFuel > 0 && STATE.running) {
                ctx.fillStyle = `rgba(255, ${Math.random() * 150}, 0, 0.8)`;
                ctx.beginPath();
                ctx.moveTo(rocketX + 5, rocketScreenY + rocketH);
                ctx.lineTo(rocketX + rocketW / 2, rocketScreenY + rocketH + (Math.random() * 40 * scale));
                ctx.lineTo(rocketX + rocketW - 5, rocketScreenY + rocketH);
                ctx.fill();
            }

            // Body
            ctx.fillStyle = "#e0e0e0";
            ctx.fillRect(rocketX, rocketScreenY, rocketW, rocketH);

            // Nose Cone
            ctx.fillStyle = "#fc3d21";
            ctx.beginPath();
            ctx.moveTo(rocketX, rocketScreenY);
            ctx.lineTo(rocketX + rocketW / 2, rocketScreenY - 20 * scale);
            ctx.lineTo(rocketX + rocketW, rocketScreenY);
            ctx.fill();

            // Fins
            ctx.fillStyle = "#0b3d91";
            ctx.beginPath();
            ctx.moveTo(rocketX, rocketScreenY + rocketH);
            ctx.lineTo(rocketX - 10 * scale, rocketScreenY + rocketH + 10 * scale);
            ctx.lineTo(rocketX, rocketScreenY + rocketH - 20 * scale);
            ctx.fill();

            ctx.beginPath();
            ctx.moveTo(rocketX + rocketW, rocketScreenY + rocketH);
            ctx.lineTo(rocketX + rocketW + 10 * scale, rocketScreenY + rocketH + 10 * scale);
            ctx.lineTo(rocketX + rocketW, rocketScreenY + rocketH - 20 * scale);
            ctx.fill();

            // Altitude Markers
            ctx.fillStyle = "rgba(255,255,255,0.3)";
            for (let i = 0; i < STATE.y + 500; i += 100) {
                if (i === 0) continue;
                const markY = groundY - (i * scale * 5);
                if (markY < h && markY > 0) {
                    ctx.fillRect(w / 2 + 50, markY, 20, 2);
                    ctx.fillText(i + "m", w / 2 + 75, markY + 4);
                }
            }
        }

        /**
         * PLOTTING SYSTEM
         */
        function drawPlot() {
            const ctx = els.plotCtx;
            const w = els.plotCanvas.width;
            const h = els.plotCanvas.height;

            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, w, h);

            if (STATE.history.length < 2) return;

            // Scales
            const maxTime = Math.max(10, STATE.t);
            const maxAlt = Math.max(100, ...STATE.history.map(d => d.y));

            // Draw Grid
            ctx.strokeStyle = "#333";
            ctx.lineWidth = 1;
            ctx.beginPath();
            for (let i = 0; i < w; i += w / 10) { ctx.moveTo(i, 0); ctx.lineTo(i, h); }
            for (let i = 0; i < h; i += h / 5) { ctx.moveTo(0, i); ctx.lineTo(w, i); }
            ctx.stroke();

            // Plot Altitude (Green)
            ctx.strokeStyle = "#0f0";
            ctx.lineWidth = 2;
            ctx.beginPath();
            STATE.history.forEach((pt, i) => {
                const x = (pt.t / maxTime) * w;
                const y = h - (pt.y / maxAlt) * h;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();

            // Plot Velocity (Yellow, normalized to fit)
            const maxVel = Math.max(100, ...STATE.history.map(d => d.v));
            ctx.strokeStyle = "#ff0";
            ctx.beginPath();
            STATE.history.forEach((pt, i) => {
                const x = (pt.t / maxTime) * w;
                const y = h - (pt.v / maxVel) * (h / 2); // Uses half height
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();

            // Legend
            ctx.fillStyle = "#0f0"; ctx.fillText(`Alt Max: ${maxAlt.toFixed(0)}m`, 10, 20);
            ctx.fillStyle = "#ff0"; ctx.fillText(`Vel Max: ${maxVel.toFixed(0)}m/s`, 10, 40);
        }

        // Main Loop
        function loop() {
            if (STATE.running) {
                stepPhysics();
                drawWorld();
                drawPlot();
                requestAnimationFrame(loop);
            }
        }

        function launch() {
            if (STATE.running) return;
            STATE.running = true;
            STATE.finished = false;
            els.displays.status.innerText = "IN FLIGHT";
            loop();
        }

        function reset() {
            STATE.running = false;
            STATE.finished = false;
            STATE.t = 0;
            STATE.y = 0;
            STATE.v = 0;
            STATE.a = 0;
            STATE.history = [];
            updateParams();
            drawWorld();
            drawPlot();
            els.displays.status.innerText = "READY";
            updateTelemetry();
        }

        // Start
        init();

    </script>
</body>

</html>